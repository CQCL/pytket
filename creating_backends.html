

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>How to create your own Backend using pytket &#8212; pytket examples</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'creating_backends';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Advanced Expectation Values and Measurement Reduction" href="measurement_reduction_example.html" />
    <link rel="prev" title="Contextual optimisation" href="contextual_optimization.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="README.html">
  
  
  
  
    
    
      
    
    
    <img src="_static/Quantinuum_logo_black.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="_static/Quantinuum_logo_white.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ansatz_sequence_example.html">Ansatz Sequencing</a></li>
<li class="toctree-l1"><a class="reference internal" href="circuit_analysis_example.html">Circuit analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="circuit_generation_example.html">Circuit generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="compilation_example.html">Compilation passes</a></li>
<li class="toctree-l1"><a class="reference internal" href="conditional_gate_example.html">Conditional Execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="contextual_optimization.html">Contextual optimisation</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">How to create your own <code class="docutils literal notranslate"><span class="pre">Backend</span></code> using <code class="docutils literal notranslate"><span class="pre">pytket</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="measurement_reduction_example.html">Advanced Expectation Values and Measurement Reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="mapping_example.html">Qubit Mapping and Routing</a></li>
<li class="toctree-l1"><a class="reference internal" href="symbolics_example.html">Symbolic compilation</a></li>
<li class="toctree-l1"><a class="reference internal" href="ucc_vqe.html">VQE for Unitary Coupled Cluster using tket</a></li>
<li class="toctree-l1"><a class="reference internal" href="pytket-qujax_qaoa.html">Symbolic circuits with <code class="docutils literal notranslate"><span class="pre">qujax</span></code> and <code class="docutils literal notranslate"><span class="pre">pytket-qujax</span></code><br/></a></li>



<li class="toctree-l1"><a class="reference internal" href="pytket-qujax-classification.html">Binary Classification using pytket-qujax</a></li>




<li class="toctree-l1"><a class="reference internal" href="benchmarking/README.html">Benchmarking</a></li>
<li class="toctree-l1"><a class="reference internal" href="backends_example.html">TKET Backend Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="comparing_simulators.html">Comparison of the simulators available through tket</a></li>
<li class="toctree-l1"><a class="reference internal" href="qiskit_integration.html">Integrating <code class="docutils literal notranslate"><span class="pre">pytket</span></code> into Qiskit software</a></li>
<li class="toctree-l1"><a class="reference internal" href="Forest_portability_example.html">Code Portability and Intro to Forest</a></li>
<li class="toctree-l1"><a class="reference internal" href="expectation_value_example.html">Expectation Values</a></li>
<li class="toctree-l1"><a class="reference internal" href="entanglement_swapping.html">Iterated Entanglement Swapping using tket</a></li>
<li class="toctree-l1"><a class="reference internal" href="pytket-qujax_heisenberg_vqe.html">Let’s start with a tket circuit<br/></a></li>





<li class="toctree-l1"><a class="reference internal" href="spam_example.html">Calibration and Correction of State Preparation and Measurement (SPAM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="tket_benchmarking.html">tket benchmarking example</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/creating_backends.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>How to create your own Backend using pytket</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="how-to-create-your-own-backend-using-pytket">
<h1>How to create your own <code class="docutils literal notranslate"><span class="pre">Backend</span></code> using <code class="docutils literal notranslate"><span class="pre">pytket</span></code><a class="headerlink" href="#how-to-create-your-own-backend-using-pytket" title="Permalink to this heading">#</a></h1>
<p>In this tutorial, we will focus on:<br></p>
<ul class="simple">
<li><p>the components of the abstract <code class="docutils literal notranslate"><span class="pre">Backend</span></code> class;<br></p></li>
<li><p>adaptations for statevector simulation versus measurement sampling.</p></li>
</ul>
<p>To run this example, you will only need the core <code class="docutils literal notranslate"><span class="pre">pytket</span></code> package.<br>
<br>
The <code class="docutils literal notranslate"><span class="pre">pytket</span></code> framework currently has direct integration with the largest variety of devices and simulators out of any quantum software platform, but this is certainly not a complete collection. New quantum backends are frequently being rolled out as more device manufacturers bring their machines online and advanced in simulation research give rise to many purpose-built simulators for fast execution of specific circuit fragments.<br>
<br>
If you have something that can take circuits (i.e. a sequence of gates) and run/simulate them, adding integration with <code class="docutils literal notranslate"><span class="pre">pytket</span></code> connects it to a great number of users and enables existing software solutions to immediately take advantage of your new backend. This reach is further extended beyond just software written with <code class="docutils literal notranslate"><span class="pre">pytket</span></code> by exploiting its integration with the rest of the quantum software ecosystem, such as via the <code class="docutils literal notranslate"><span class="pre">TketBackend</span></code> wrapper to use the new backend within Qiskit projects.<br>
<br>
This notebook will take a toy simulator and demonstrate how to write each component of the <code class="docutils literal notranslate"><span class="pre">Backend</span></code> class to make it work with the rest of <code class="docutils literal notranslate"><span class="pre">pytket</span></code>. We’ll start by defining the internal representation of a circuit that our simulator will use. Rather than common gates, this example will use exponentiated Pauli tensors (<span class="math notranslate nohighlight">\(e^{-i \theta P}\)</span> for <span class="math notranslate nohighlight">\(P \in \{I, X, Y, Z\}^n\)</span>) as its basic operation, which are universal for unitary circuits. To keep it simple, we will ignore measurements for now and just consider unitaries.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pytket</span> <span class="kn">import</span> <span class="n">Qubit</span>
<span class="kn">from</span> <span class="nn">pytket.pauli</span> <span class="kn">import</span> <span class="n">QubitPauliString</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyCircuit</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A minimal representation of a unitary circuit&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qubits</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Qubit</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a circuit over some set of qubits</span>
<span class="sd">        :param qubits: The list of qubits in the circuit</span>
<span class="sd">        :type qubits: List[Qubit]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qubits</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">add_gate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qps</span><span class="p">:</span> <span class="n">QubitPauliString</span><span class="p">,</span> <span class="n">angle</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds a gate to the end of the circuit e^{-0.5i * qps * angle}</span>
<span class="sd">        :param qps: Pauli string to rotate around</span>
<span class="sd">        :type qps: QubitPauliString</span>
<span class="sd">        :param angle: Angle of rotation in radians</span>
<span class="sd">        :type angle: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">qps</span><span class="p">,</span> <span class="n">angle</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>To simulate these, it is enough to generate the matrix of these exponentials and apply them in sequence to our initial state. Calculating these matrix exponentials is easy since we can exploit the following property: if an operator <span class="math notranslate nohighlight">\(A\)</span> satisfies <span class="math notranslate nohighlight">\(A^2 = I\)</span>, then <span class="math notranslate nohighlight">\(e^{i\theta A} = \mathrm{cos}(\theta)I + i \mathrm{sin}(\theta) A\)</span>. This works for any tensor of Pauli matrices. Furthermore, since each Pauli matrix is some combination of a diagonal matrix and a permutation matrix, they benefit greatly from a sparse matrix representation, which we can obtain from the <code class="docutils literal notranslate"><span class="pre">QubitPauliString</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MySimulator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A minimal statevector simulator for unitary circuits&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qubits</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Qubit</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise a statevector, setting all qubits to the |0❭ state.</span>
<span class="sd">        We treat qubits[0] as the most-significant qubit</span>
<span class="sd">        :param qubits: The list of qubits in the circuit</span>
<span class="sd">        :type qubits: List[Qubit]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qubits</span> <span class="o">=</span> <span class="n">qubits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qstate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span> <span class="o">**</span> <span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">),),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qstate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">def</span> <span class="nf">apply_Pauli_rot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qps</span><span class="p">:</span> <span class="n">QubitPauliString</span><span class="p">,</span> <span class="n">angle</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Applies e^{-0.5i * qps * angle} to the state</span>
<span class="sd">        :param qps: Pauli to rotate around</span>
<span class="sd">        :type qps: QubitPauliString</span>
<span class="sd">        :param angle: Angle of rotation in radians</span>
<span class="sd">        :type angle: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pauli_tensor</span> <span class="o">=</span> <span class="n">qps</span><span class="o">.</span><span class="n">to_sparse_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_qubits</span><span class="p">)</span>
        <span class="n">exponent</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">angle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qstate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">exponent</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qstate</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span>
            <span class="n">exponent</span>
        <span class="p">)</span> <span class="o">*</span> <span class="n">pauli_tensor</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_qstate</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_mycircuit</span><span class="p">(</span><span class="n">circ</span><span class="p">:</span> <span class="n">MyCircuit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gives the state after applying the circuit to the all-|0❭ state</span>
<span class="sd">    :param circ: The circuit to simulate</span>
<span class="sd">    :type circ: MyCircuit</span>
<span class="sd">    :return: The final statevector</span>
<span class="sd">    :rtype: np.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">MySimulator</span><span class="p">(</span><span class="n">circ</span><span class="o">.</span><span class="n">qubits</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">qps</span><span class="p">,</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">circ</span><span class="o">.</span><span class="n">gates</span><span class="p">:</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">apply_Pauli_rot</span><span class="p">(</span><span class="n">qps</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sim</span><span class="o">.</span><span class="n">_qstate</span>
</pre></div>
</div>
</div>
</div>
<p>And that’s all we need for a basic simulator! We can check that this works by trying to generate a Bell state (up to global phase).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pytket.pauli</span> <span class="kn">import</span> <span class="n">Pauli</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="n">Qubit</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">Qubit</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span>
<span class="n">circ</span> <span class="o">=</span> <span class="n">MyCircuit</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<span class="c1"># Hadamard on Qubit(0)</span>
<span class="n">circ</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="n">QubitPauliString</span><span class="p">(</span><span class="n">Qubit</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">Z</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">circ</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="n">QubitPauliString</span><span class="p">(</span><span class="n">Qubit</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">circ</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="n">QubitPauliString</span><span class="p">(</span><span class="n">Qubit</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">Z</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="c1"># CX with control Qubit(0) and target Qubit(1)</span>
<span class="n">circ</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="n">QubitPauliString</span><span class="p">(</span><span class="n">Qubit</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">Z</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">circ</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="n">QubitPauliString</span><span class="p">(</span><span class="n">Qubit</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">X</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">circ</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="n">QubitPauliString</span><span class="p">({</span><span class="n">Qubit</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="n">Qubit</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">X</span><span class="p">}),</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">run_mycircuit</span><span class="p">(</span><span class="n">circ</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[ 5.00000000e-01-5.00000000e-01j -1.11022302e-16-5.55111512e-17j
  0.00000000e+00+0.00000000e+00j  5.00000000e-01-5.00000000e-01j]
</pre></div>
</div>
</div>
</div>
<p>A useful first step to integrating this is to define a conversion from the <code class="docutils literal notranslate"><span class="pre">pytket.Circuit</span></code> class to the <code class="docutils literal notranslate"><span class="pre">MyCircuit</span></code> class. In most cases, this will just amount to converting one gate at a time by a simple syntax map. We need not specify how to convert every possible <code class="docutils literal notranslate"><span class="pre">OpType</span></code>, since we can rely on the compilation passes in <code class="docutils literal notranslate"><span class="pre">pytket</span></code> to map the circuit into the required gate set as long as it is universal. For this example, the definitions of <code class="docutils literal notranslate"><span class="pre">OpType.Rx</span></code>, <code class="docutils literal notranslate"><span class="pre">OpType.Ry</span></code>, <code class="docutils literal notranslate"><span class="pre">OpType.Rz</span></code>, and <code class="docutils literal notranslate"><span class="pre">OpType.ZZMax</span></code> all match the form of a single Pauli exponential.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pytket</span> <span class="kn">import</span> <span class="n">Circuit</span><span class="p">,</span> <span class="n">OpType</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">tk_to_mycircuit</span><span class="p">(</span><span class="n">tkc</span><span class="p">:</span> <span class="n">Circuit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MyCircuit</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a pytket Circuit to a MyCircuit object.</span>
<span class="sd">    Supports Rz, Rx, Ry, and ZZMax gates.</span>
<span class="sd">    :param tkc: The Circuit to convert</span>
<span class="sd">    :type tkc: Circuit</span>
<span class="sd">    :return: An equivalent MyCircuit object</span>
<span class="sd">    :rtype: MyCircuit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">circ</span> <span class="o">=</span> <span class="n">MyCircuit</span><span class="p">(</span><span class="n">tkc</span><span class="o">.</span><span class="n">qubits</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">tkc</span><span class="p">:</span>
        <span class="n">optype</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">type</span>
        <span class="k">if</span> <span class="n">optype</span> <span class="o">==</span> <span class="n">OpType</span><span class="o">.</span><span class="n">Rx</span><span class="p">:</span>
            <span class="n">circ</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span>
                <span class="n">QubitPauliString</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">command</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="n">OpType</span><span class="o">.</span><span class="n">Ry</span><span class="p">:</span>
            <span class="n">circ</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span>
                <span class="n">QubitPauliString</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">Y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">command</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="n">OpType</span><span class="o">.</span><span class="n">Rz</span><span class="p">:</span>
            <span class="n">circ</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span>
                <span class="n">QubitPauliString</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">Z</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">command</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="n">OpType</span><span class="o">.</span><span class="n">ZZMax</span><span class="p">:</span>
            <span class="n">circ</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span>
                <span class="n">QubitPauliString</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="p">[</span><span class="n">Pauli</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">Z</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot convert optype to MyCircuit: &quot;</span><span class="p">,</span> <span class="n">optype</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">circ</span>
</pre></div>
</div>
</div>
</div>
<p>Now we turn to the <code class="docutils literal notranslate"><span class="pre">Backend</span></code> class. This provides a uniform API to submit <code class="docutils literal notranslate"><span class="pre">Circuit</span></code> objects for evaluation, typically returning either a statevector or a set of measurement shots. It also captures all of the information needed for compilation and asynchronous job management.<br>
<br>
We will make a subclass of <code class="docutils literal notranslate"><span class="pre">Backend</span></code> for our statevector simulator. The <code class="docutils literal notranslate"><span class="pre">_supports_state</span></code> flag lets the methods of the abstract <code class="docutils literal notranslate"><span class="pre">Backend</span></code> class know that this implementation supports statevector simulation. We also set <code class="docutils literal notranslate"><span class="pre">_persistent_handles</span></code> to <code class="docutils literal notranslate"><span class="pre">False</span></code> since this <code class="docutils literal notranslate"><span class="pre">Backend</span></code> will not be able to retrieve results from a previous Python session.<br>
<br>
Since we do not need to connect to a remote process for the simulator, the constructor doesn’t need to set anything up. The base <code class="docutils literal notranslate"><span class="pre">Backend</span></code> constructor will initialise the <code class="docutils literal notranslate"><span class="pre">_cache</span></code> field for storing job data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pytket.backends</span> <span class="kn">import</span> <span class="n">Backend</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyBackend</span><span class="p">(</span><span class="n">Backend</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A pytket Backend wrapping around the MySimulator statevector simulator&quot;&quot;&quot;</span>
    <span class="n">_supports_state</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_persistent_handles</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new instance of the MyBackend class&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Most <code class="docutils literal notranslate"><span class="pre">Backend</span></code>s will only support a small fragment of the <code class="docutils literal notranslate"><span class="pre">Circuit</span></code> language, either through implementation limitations or since a specific presentation is universal. It is helpful to keep this information in the <code class="docutils literal notranslate"><span class="pre">Backend</span></code> object itself so that users can clearly see how a <code class="docutils literal notranslate"><span class="pre">Circuit</span></code> needs to look before it can be successfully run. The <code class="docutils literal notranslate"><span class="pre">Predicate</span></code> classes in <code class="docutils literal notranslate"><span class="pre">pytket</span></code> can capture many common restrictions. The idea behind the <code class="docutils literal notranslate"><span class="pre">required_predicates</span></code> list is that any <code class="docutils literal notranslate"><span class="pre">Circuit</span></code> satisfying every <code class="docutils literal notranslate"><span class="pre">Predicate</span></code> in the list can be run on the <code class="docutils literal notranslate"><span class="pre">Backend</span></code> successfully as it is.<br>
<br>
However, a typical high-level user will not be writing <code class="docutils literal notranslate"><span class="pre">Circuit</span></code>s that satisfies all of the <code class="docutils literal notranslate"><span class="pre">required_predicates</span></code>, preferring instead to use the model that is most natural for the algorithm they are implementing. Providing a <code class="docutils literal notranslate"><span class="pre">default_compilation_pass</span></code> gives users an easy starting point for compiling an arbitrary <code class="docutils literal notranslate"><span class="pre">Circuit</span></code> into a form that can be executed (when not blocked by paradigm constraints like <code class="docutils literal notranslate"><span class="pre">NoMidMeasurePredicate</span></code> or <code class="docutils literal notranslate"><span class="pre">NoClassicalControlPredicate</span></code> that cannot easily be solved by compilation).<br>
<br>
You can provide several options using the <code class="docutils literal notranslate"><span class="pre">optimisation_level</span></code> argument. We tend to use <code class="docutils literal notranslate"><span class="pre">0</span></code> for very basic compilation with no optimisation applied, <code class="docutils literal notranslate"><span class="pre">1</span></code> for the inclusion of fast optimisations (e.g. <code class="docutils literal notranslate"><span class="pre">SynthesiseIBM</span></code> is a pre-defined sequence of optimisation passes that scales well with circuit size), and <code class="docutils literal notranslate"><span class="pre">2</span></code> for heavier optimisation (e.g. <code class="docutils literal notranslate"><span class="pre">FullPeepholeOptimise</span></code> incorporates <code class="docutils literal notranslate"><span class="pre">SynthesiseTket</span></code> alongside some extra passes that may take longer for large circuits).<br>
<br>
When designing these compilation pass sequences for a given <code class="docutils literal notranslate"><span class="pre">Backend</span></code>, it can be a good idea to start with the passes that solve individual constraints from <code class="docutils literal notranslate"><span class="pre">required_predicates</span></code> (like <code class="docutils literal notranslate"><span class="pre">FullMappingPass</span></code> for <code class="docutils literal notranslate"><span class="pre">ConnectivityPredicate</span></code> or <code class="docutils literal notranslate"><span class="pre">RebaseX</span></code> for <code class="docutils literal notranslate"><span class="pre">GateSetPredicate</span></code>), and find an ordering such that no later pass invalidates the work of an earlier one.<br>
<br>
For <code class="docutils literal notranslate"><span class="pre">MyBackend</span></code>, we will need to enforce that our circuits are expressed entirely in terms of <code class="docutils literal notranslate"><span class="pre">OpType.Rx</span></code>, <code class="docutils literal notranslate"><span class="pre">OpType.Ry</span></code>, <code class="docutils literal notranslate"><span class="pre">OpType.Rz</span></code>, and <code class="docutils literal notranslate"><span class="pre">OpType.ZZMax</span></code> gates which we can solve using <code class="docutils literal notranslate"><span class="pre">RebaseCustom</span></code>. Note that we omit <code class="docutils literal notranslate"><span class="pre">OpType.Measure</span></code> since we can only run pure quantum circuits.<br>
<br>
The standard docstrings for these and other abstract methods can be seen in the abstract <code class="docutils literal notranslate"><span class="pre">Backend</span></code> <a class="reference external" href="https://cqcl.github.io/tket/pytket/api/backends.html#pytket.backends.Backend">API reference</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pytket.predicates</span> <span class="kn">import</span> <span class="n">Predicate</span><span class="p">,</span> <span class="n">GateSetPredicate</span><span class="p">,</span> <span class="n">NoClassicalBitsPredicate</span>
<span class="kn">from</span> <span class="nn">pytket.passes</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BasePass</span><span class="p">,</span>
    <span class="n">SequencePass</span><span class="p">,</span>
    <span class="n">DecomposeBoxes</span><span class="p">,</span>
    <span class="n">SynthesiseTket</span><span class="p">,</span>
    <span class="n">FullPeepholeOptimise</span><span class="p">,</span>
    <span class="n">RebaseCustom</span><span class="p">,</span>
    <span class="n">SquashCustom</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">required_predicates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Predicate</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The minimum set of predicates that a circuit must satisfy before it can</span>
<span class="sd">    be successfully run on this backend.</span>
<span class="sd">    :return: Required predicates.</span>
<span class="sd">    :rtype: List[Predicate]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">NoClassicalBitsPredicate</span><span class="p">(),</span>
        <span class="n">GateSetPredicate</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="n">OpType</span><span class="o">.</span><span class="n">Rx</span><span class="p">,</span>
                <span class="n">OpType</span><span class="o">.</span><span class="n">Ry</span><span class="p">,</span>
                <span class="n">OpType</span><span class="o">.</span><span class="n">Rz</span><span class="p">,</span>
                <span class="n">OpType</span><span class="o">.</span><span class="n">ZZMax</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">),</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">preds</span>
</pre></div>
</div>
</div>
</div>
<p>Every <code class="docutils literal notranslate"><span class="pre">Backend</span></code> must define a rebasing method, which will normally be called from its default compilation passes (see below), but which may also be called independently. Given the target gate set, it is usually straightforward to define this using the <code class="docutils literal notranslate"><span class="pre">RebaseCustom</span></code> pass, with a couple of helpers defining rebase of an <code class="docutils literal notranslate"><span class="pre">OpType.CX</span></code> and a general <code class="docutils literal notranslate"><span class="pre">OpType.TK1</span></code> gate:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cx_circ</span> <span class="o">=</span> <span class="n">Circuit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">cx_circ</span><span class="o">.</span><span class="n">Sdg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">cx_circ</span><span class="o">.</span><span class="n">V</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">cx_circ</span><span class="o">.</span><span class="n">Sdg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">cx_circ</span><span class="o">.</span><span class="n">Vdg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">cx_circ</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="n">OpType</span><span class="o">.</span><span class="n">ZZMax</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">cx_circ</span><span class="o">.</span><span class="n">Vdg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">cx_circ</span><span class="o">.</span><span class="n">Sdg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">cx_circ</span><span class="o">.</span><span class="n">add_phase</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Sdg q[0]; V q[1]; Sdg q[1]; Vdg q[1]; ZZMax q[0], q[1]; Vdg q[1]; Sdg q[1]; ]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sq</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">circ</span> <span class="o">=</span> <span class="n">Circuit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">circ</span><span class="o">.</span><span class="n">Rz</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">circ</span><span class="o">.</span><span class="n">Rx</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">circ</span><span class="o">.</span><span class="n">Rz</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">circ</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rebase</span> <span class="o">=</span> <span class="n">RebaseCustom</span><span class="p">({</span><span class="n">OpType</span><span class="o">.</span><span class="n">Rx</span><span class="p">,</span> <span class="n">OpType</span><span class="o">.</span><span class="n">Ry</span><span class="p">,</span> <span class="n">OpType</span><span class="o">.</span><span class="n">Rz</span><span class="p">,</span> <span class="n">OpType</span><span class="o">.</span><span class="n">ZZMax</span><span class="p">},</span> <span class="n">cx_circ</span><span class="p">,</span> <span class="n">sq</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">default_compilation_pass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optimisation_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BasePass</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A suggested compilation pass that will guarantee the resulting circuit</span>
<span class="sd">    will be suitable to run on this backend with as few preconditions as</span>
<span class="sd">    possible.</span>
<span class="sd">    :param optimisation_level: The level of optimisation to perform during</span>
<span class="sd">        compilation. Level 0 just solves the device constraints without</span>
<span class="sd">        optimising. Level 1 additionally performs some light optimisations.</span>
<span class="sd">        Level 2 adds more intensive optimisations that can increase compilation</span>
<span class="sd">        time for large circuits. Defaults to 1.</span>
<span class="sd">    :type optimisation_level: int, optional</span>
<span class="sd">    :return: Compilation pass guaranteeing required predicates.</span>
<span class="sd">    :rtype: BasePass</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">optimisation_level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">squash</span> <span class="o">=</span> <span class="n">SquashCustom</span><span class="p">({</span><span class="n">OpType</span><span class="o">.</span><span class="n">Rz</span><span class="p">,</span> <span class="n">OpType</span><span class="o">.</span><span class="n">Rx</span><span class="p">,</span> <span class="n">OpType</span><span class="o">.</span><span class="n">Ry</span><span class="p">},</span> <span class="n">sq</span><span class="p">)</span>
    <span class="n">seq</span> <span class="o">=</span> <span class="p">[</span><span class="n">DecomposeBoxes</span><span class="p">()]</span>  <span class="c1"># Decompose boxes into basic gates</span>
    <span class="k">if</span> <span class="n">optimisation_level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SynthesiseTket</span><span class="p">())</span>  <span class="c1"># Optional fast optimisation</span>
    <span class="k">elif</span> <span class="n">optimisation_level</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FullPeepholeOptimise</span><span class="p">())</span>  <span class="c1"># Optional heavy optimisation</span>
    <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rebase</span><span class="p">)</span>  <span class="c1"># Map to target gate set</span>
    <span class="k">if</span> <span class="n">optimisation_level</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">squash</span><span class="p">)</span>  <span class="c1"># Optionally simplify 1qb gate chains within this gate set</span>
    <span class="k">return</span> <span class="n">SequencePass</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">backend_info</span></code> property is used for storing various properties of a backend. By default it provides all device information useful for compilation. Typically we would  make it return a class attribute <code class="docutils literal notranslate"><span class="pre">self._backend_info</span></code> that we initialise on construction, but we will define it at point of request here. We use a <code class="docutils literal notranslate"><span class="pre">FullyConnected</span></code> architecture producing an <code class="docutils literal notranslate"><span class="pre">Architecture</span></code> object with couplings between 4 qubits.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pytket.backends.backendinfo</span> <span class="kn">import</span> <span class="n">BackendInfo</span>
<span class="kn">from</span> <span class="nn">pytket.architecture</span> <span class="kn">import</span> <span class="n">FullyConnected</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">backend_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BackendInfo</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">BackendInfo</span><span class="p">(</span>
        <span class="s2">&quot;MyBackend&quot;</span><span class="p">,</span>
        <span class="s2">&quot;MySimulator&quot;</span><span class="p">,</span>
        <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
        <span class="n">FullyConnected</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
        <span class="p">{</span>
            <span class="n">OpType</span><span class="o">.</span><span class="n">Rx</span><span class="p">,</span>
            <span class="n">OpType</span><span class="o">.</span><span class="n">Ry</span><span class="p">,</span>
            <span class="n">OpType</span><span class="o">.</span><span class="n">Rz</span><span class="p">,</span>
            <span class="n">OpType</span><span class="o">.</span><span class="n">ZZMax</span><span class="p">,</span>
            <span class="n">OpType</span><span class="o">.</span><span class="n">Measure</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">supports_midcircuit_measurement</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">misc</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;characterisation&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Asynchronous job management is all managed through the <code class="docutils literal notranslate"><span class="pre">ResultHandle</span></code> associated with a particular <code class="docutils literal notranslate"><span class="pre">Circuit</span></code> that has been submitted. We can use it to inspect the status of the job to see if it has completed, or to look up the results if they are available.<br>
<br>
For devices, <code class="docutils literal notranslate"><span class="pre">circuit_status</span></code> should query the job to see if it is in a queue, currently being executed, completed successfully, etc. The <code class="docutils literal notranslate"><span class="pre">CircuitStatus</span></code> class is mostly driven by the <code class="docutils literal notranslate"><span class="pre">StatusEnum</span></code> values, but can also contain messages to give more detailed feedback if available. For our simulator, we are not running things asynchronously, so a <code class="docutils literal notranslate"><span class="pre">Circuit</span></code> has either not been run or it will have been completed.<br>
<br>
Since a device API will probably define its own data type for job handles, the <code class="docutils literal notranslate"><span class="pre">ResultHandle</span></code> definition is flexible enough to cover many possible data types so you can likely use the underlying job handle as the <code class="docutils literal notranslate"><span class="pre">ResultHandle</span></code>. The <code class="docutils literal notranslate"><span class="pre">_result_id_type</span></code> property specifies what data type a <code class="docutils literal notranslate"><span class="pre">ResultHandle</span></code> for this <code class="docutils literal notranslate"><span class="pre">Backend</span></code> should look like. Since our simulator has no underlying job handle, we can just use a UUID string.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pytket.backends</span> <span class="kn">import</span> <span class="n">ResultHandle</span><span class="p">,</span> <span class="n">CircuitStatus</span><span class="p">,</span> <span class="n">StatusEnum</span><span class="p">,</span> <span class="n">CircuitNotRunError</span>
<span class="kn">from</span> <span class="nn">pytket.backends.resulthandle</span> <span class="kn">import</span> <span class="n">_ResultIdTuple</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">_result_id_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_ResultIdTuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identifier type signature for ResultHandle for this backend.</span>
<span class="sd">    :return: Type signature (tuple of hashable types)</span>
<span class="sd">    :rtype: _ResultIdTuple</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">str</span><span class="p">,)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">circuit_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">:</span> <span class="n">ResultHandle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CircuitStatus</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a CircuitStatus reporting the status of the circuit execution</span>
<span class="sd">    corresponding to the ResultHandle</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">handle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CircuitStatus</span><span class="p">(</span><span class="n">StatusEnum</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">CircuitNotRunError</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And finally, we have the method that actually submits a job for execution. <code class="docutils literal notranslate"><span class="pre">process_circuits</span></code> should take a collection of (compiled) <code class="docutils literal notranslate"><span class="pre">Circuit</span></code> objects, process them and return a <code class="docutils literal notranslate"><span class="pre">ResultHandle</span></code> for each <code class="docutils literal notranslate"><span class="pre">Circuit</span></code>. If execution is synchronous, then this can simply wait until it is finished, store the result in <code class="docutils literal notranslate"><span class="pre">_cache</span></code> and return. For backends that support asynchronous jobs, you will need to set up an event to format and store the result on completion.<br>
<br>
It is recommended to use the <code class="docutils literal notranslate"><span class="pre">valid_check</span></code> parameter to control a call to <code class="docutils literal notranslate"><span class="pre">Backend._check_all_circuits()</span></code>, which will raise an exception if any of the circuits do not satisfy everything in <code class="docutils literal notranslate"><span class="pre">required_predicates</span></code>.<br>
<br>
The <code class="docutils literal notranslate"><span class="pre">_cache</span></code> fields stores all of the information about current jobs that have been run. When a job has finished execution, the results are expected to be stored in <code class="docutils literal notranslate"><span class="pre">_cache[handle][&quot;result&quot;]</span></code>, though it can also be used to store other data about the job such as some information about the <code class="docutils literal notranslate"><span class="pre">Circuit</span></code> required to properly format the results. Methods like <code class="docutils literal notranslate"><span class="pre">Backend.get_result()</span></code> and <code class="docutils literal notranslate"><span class="pre">Backend.empty_cache()</span></code> expect to interact with the results of a given job in this way.<br>
<br>
The final output of the execution is stored in a <code class="docutils literal notranslate"><span class="pre">BackendResult</span></code> object. This captures enough information about the results to reinterpret it in numerous ways, such as requesting the statevector in a specific qubit ordering or converting a complete shot table to a summary of the counts. If we create a <code class="docutils literal notranslate"><span class="pre">BackendResult</span></code> with quantum data (e.g. a statevector or unitary), we must provide the <code class="docutils literal notranslate"><span class="pre">Qubit</span></code> ids in order from most-significant to least-significant with regards to indexing the state. Similarly, creating one with classical readouts (e.g. a shot table or counts summary), we give the <code class="docutils literal notranslate"><span class="pre">Bit</span></code> ids in the order they appear in a readout (left-to-right).<br>
<br>
For a statevector simulation, we should also take into account the global phase stored in the <code class="docutils literal notranslate"><span class="pre">Circuit</span></code> object and any implicit qubit permutations, since these become observable when inspecting the quantum state. We can handle the qubit permutation by changing the order in which we pass the <code class="docutils literal notranslate"><span class="pre">Qubit</span></code> ids into the <code class="docutils literal notranslate"><span class="pre">BackendResult</span></code> object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pytket.backends.backendresult</span> <span class="kn">import</span> <span class="n">BackendResult</span>
<span class="kn">from</span> <span class="nn">pytket.utils.results</span> <span class="kn">import</span> <span class="n">KwargTypes</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_circuits</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">circuits</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Circuit</span><span class="p">],</span>
    <span class="n">n_shots</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">valid_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">KwargTypes</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ResultHandle</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Submit circuits to the backend for running. The results will be stored</span>
<span class="sd">    in the backend&#39;s result cache to be retrieved by the corresponding</span>
<span class="sd">    get_&lt;data&gt; method.</span>
<span class="sd">    Use keyword arguments to specify parameters to be used in submitting circuits</span>
<span class="sd">    See specific Backend derived class for available parameters, from the following</span>
<span class="sd">    list:</span>
<span class="sd">    * `seed`: RNG seed for simulators</span>
<span class="sd">    :param circuits: Circuits to process on the backend.</span>
<span class="sd">    :type circuits: Iterable[Circuit]</span>
<span class="sd">    :param n_shots: Number of shots to run per circuit. None is to be used</span>
<span class="sd">        for state/unitary simulators. Defaults to None.</span>
<span class="sd">    :type n_shots: Optional[int], optional</span>
<span class="sd">    :param valid_check: Explicitly check that all circuits satisfy all required</span>
<span class="sd">        predicates to run on the backend. Defaults to True</span>
<span class="sd">    :type valid_check: bool, optional</span>
<span class="sd">    :return: Handles to results for each input circuit, as an interable in</span>
<span class="sd">        the same order as the circuits.</span>
<span class="sd">    :rtype: List[ResultHandle]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">circuit_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">circuits</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">valid_check</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_all_circuits</span><span class="p">(</span><span class="n">circuit_list</span><span class="p">)</span>
    <span class="n">handle_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">circuit</span> <span class="ow">in</span> <span class="n">circuit_list</span><span class="p">:</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">ResultHandle</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()))</span>
        <span class="n">mycirc</span> <span class="o">=</span> <span class="n">tk_to_mycircuit</span><span class="p">(</span><span class="n">circuit</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">run_mycircuit</span><span class="p">(</span><span class="n">mycirc</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">circuit</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span>
        <span class="n">implicit_perm</span> <span class="o">=</span> <span class="n">circuit</span><span class="o">.</span><span class="n">implicit_qubit_permutation</span><span class="p">()</span>
        <span class="n">res_qubits</span> <span class="o">=</span> <span class="p">[</span><span class="n">implicit_perm</span><span class="p">[</span><span class="n">qb</span><span class="p">]</span> <span class="k">for</span> <span class="n">qb</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">circuit</span><span class="o">.</span><span class="n">qubits</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">BackendResult</span><span class="p">(</span><span class="n">q_bits</span><span class="o">=</span><span class="n">res_qubits</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">handle</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">}</span>
        <span class="n">handle_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">handle_list</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s redefine our <code class="docutils literal notranslate"><span class="pre">MyBackend</span></code> class to use these methods to finish it off.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyBackend</span><span class="p">(</span><span class="n">Backend</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A pytket Backend wrapping around the MySimulator statevector simulator&quot;&quot;&quot;</span>
    <span class="n">_supports_state</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_persistent_handles</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new instance of the MyBackend class&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="n">required_predicates</span> <span class="o">=</span> <span class="n">required_predicates</span>
    <span class="n">rebase_pass</span> <span class="o">=</span> <span class="n">rebase</span>
    <span class="n">default_compilation_pass</span> <span class="o">=</span> <span class="n">default_compilation_pass</span>
    <span class="n">_result_id_type</span> <span class="o">=</span> <span class="n">_result_id_type</span>
    <span class="n">circuit_status</span> <span class="o">=</span> <span class="n">circuit_status</span>
    <span class="n">process_circuits</span> <span class="o">=</span> <span class="n">process_circuits</span>
</pre></div>
</div>
</div>
</div>
<p>Our new <code class="docutils literal notranslate"><span class="pre">Backend</span></code> subclass is now complete, so let’s test it out. If you are planning on maintaining a backend class, it is recommended to set up some unit tests. The following tests will cover basic operation and integration with <code class="docutils literal notranslate"><span class="pre">pytket</span></code> utilities.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pytket.circuit</span> <span class="kn">import</span> <span class="n">BasisOrder</span><span class="p">,</span> <span class="n">Unitary1qBox</span>
<span class="kn">from</span> <span class="nn">pytket.passes</span> <span class="kn">import</span> <span class="n">CliffordSimp</span>
<span class="kn">from</span> <span class="nn">pytket.utils</span> <span class="kn">import</span> <span class="n">get_operator_expectation_value</span>
<span class="kn">from</span> <span class="nn">pytket.utils.operators</span> <span class="kn">import</span> <span class="n">QubitPauliOperator</span>
<span class="kn">import</span> <span class="nn">pytest</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_bell</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Circuit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">CX</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">MyBackend</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get_compiled_circuit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">process_circuit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
        <span class="n">b</span><span class="o">.</span><span class="n">get_result</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">get_state</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_basisorder</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Circuit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">MyBackend</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get_compiled_circuit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">process_circuit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get_result</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get_state</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get_state</span><span class="p">(</span><span class="n">basis</span><span class="o">=</span><span class="n">BasisOrder</span><span class="o">.</span><span class="n">dlo</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_implicit_perm</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Circuit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">CX</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">CX</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">Ry</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">CliffordSimp</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">MyBackend</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get_compiled_circuit</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">optimisation_level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get_compiled_circuit</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">optimisation_level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">c</span><span class="o">.</span><span class="n">implicit_qubit_permutation</span><span class="p">()</span> <span class="o">!=</span> <span class="n">c1</span><span class="o">.</span><span class="n">implicit_qubit_permutation</span><span class="p">()</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">h1</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">process_circuits</span><span class="p">([</span><span class="n">c</span><span class="p">,</span> <span class="n">c1</span><span class="p">])</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">r1</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get_results</span><span class="p">([</span><span class="n">h</span><span class="p">,</span> <span class="n">h1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">bo</span> <span class="ow">in</span> <span class="p">[</span><span class="n">BasisOrder</span><span class="o">.</span><span class="n">ilo</span><span class="p">,</span> <span class="n">BasisOrder</span><span class="o">.</span><span class="n">dlo</span><span class="p">]:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get_state</span><span class="p">(</span><span class="n">basis</span><span class="o">=</span><span class="n">bo</span><span class="p">)</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">get_state</span><span class="p">(</span><span class="n">basis</span><span class="o">=</span><span class="n">bo</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_compilation_pass</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">MyBackend</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">opt_level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">Circuit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">CX</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="n">c</span><span class="o">.</span><span class="n">add_unitary1qbox</span><span class="p">(</span><span class="n">Unitary1qBox</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">CX</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="n">OpType</span><span class="o">.</span><span class="n">CRz</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">valid_circuit</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get_compiled_circuit</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">optimisation_level</span><span class="o">=</span><span class="n">opt_level</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">b</span><span class="o">.</span><span class="n">valid_circuit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_invalid_measures</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Circuit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CX</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">measure_all</span><span class="p">()</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">MyBackend</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get_compiled_circuit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">valid_circuit</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_expectation_value</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Circuit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">CX</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">op</span> <span class="o">=</span> <span class="n">QubitPauliOperator</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="n">QubitPauliString</span><span class="p">({</span><span class="n">Qubit</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="n">Qubit</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">Z</span><span class="p">}):</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="n">QubitPauliString</span><span class="p">({</span><span class="n">Qubit</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">Qubit</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">X</span><span class="p">}):</span> <span class="mf">0.3</span><span class="p">,</span>
            <span class="n">QubitPauliString</span><span class="p">({</span><span class="n">Qubit</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="n">Qubit</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">Y</span><span class="p">}):</span> <span class="mf">0.8</span><span class="n">j</span><span class="p">,</span>
            <span class="n">QubitPauliString</span><span class="p">({</span><span class="n">Qubit</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">Y</span><span class="p">}):</span> <span class="o">-</span><span class="mf">0.4</span><span class="n">j</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">MyBackend</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get_compiled_circuit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">get_operator_expectation_value</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">==</span> <span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span><span class="mf">1.3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Explicit calls are needed for this notebook. Normally pytest will just find these “test_X” methods when run from the command line:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_bell</span><span class="p">()</span>
<span class="n">test_basisorder</span><span class="p">()</span>
<span class="n">test_implicit_perm</span><span class="p">()</span>
<span class="n">test_compilation_pass</span><span class="p">()</span>
<span class="n">test_invalid_measures</span><span class="p">()</span>
<span class="n">test_expectation_value</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>To show how this compares to a sampling simulator, let’s extend our simulator to handle end-of-circuit measurements.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Set</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sample_mycircuit</span><span class="p">(</span>
    <span class="n">circ</span><span class="p">:</span> <span class="n">MyCircuit</span><span class="p">,</span> <span class="n">qubits</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Qubit</span><span class="p">],</span> <span class="n">n_shots</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run the circuit on the all-|0❭ state and measures a set of qubits</span>
<span class="sd">    :param circ: The circuit to simulate</span>
<span class="sd">    :type circ: MyCircuit</span>
<span class="sd">    :param qubits: The set of qubits to measure</span>
<span class="sd">    :type qubits: Set[Qubit]</span>
<span class="sd">    :param n_shots: The number of samples to take</span>
<span class="sd">    :type n_shots: int</span>
<span class="sd">    :param seed: Seed for the random number generator, defaults to no seed</span>
<span class="sd">    :type seed: Optional[int], optional</span>
<span class="sd">    :return: Table of shots; each row is a shot, columns are qubit readouts in ascending Qubit order</span>
<span class="sd">    :rtype: np.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">run_mycircuit</span><span class="p">(</span><span class="n">circ</span><span class="p">)</span>
    <span class="n">cumulative_probs</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span> <span class="o">*</span> <span class="n">state</span><span class="o">.</span><span class="n">conjugate</span><span class="p">())</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">shots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_shots</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">circ</span><span class="o">.</span><span class="n">qubits</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_shots</span><span class="p">):</span>
        <span class="c1"># Pick a random point in the distribution</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="c1"># Find the corresponding readout</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">cumulative_probs</span><span class="p">,</span> <span class="n">point</span><span class="p">)</span>
        <span class="c1"># Convert index to a binary array</span>
        <span class="c1"># `bin` maps e.g. index 6 to &#39;0b110&#39;</span>
        <span class="c1"># So we ignore the first two symbols and add leading 0s to make it a fixed length</span>
        <span class="n">bitstring</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="n">index</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">circ</span><span class="o">.</span><span class="n">qubits</span><span class="p">))</span>
        <span class="n">shots</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bitstring</span><span class="p">])</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_shots</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)))</span>
    <span class="n">target</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">circ</span><span class="o">.</span><span class="n">qubits</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">qubits</span><span class="p">:</span>
            <span class="n">filtered</span><span class="p">[:,</span> <span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">shots</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">target</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">filtered</span>
</pre></div>
</div>
</div>
</div>
<p>Since <code class="docutils literal notranslate"><span class="pre">MyCircuit</span></code> doesn’t have a representation for measurement gates, our converter must return both the <code class="docutils literal notranslate"><span class="pre">MyCircuit</span></code> object and some way of capturing the measurements. Since we will also want to know how they map into our <code class="docutils literal notranslate"><span class="pre">Bit</span></code> ids, the simplest option is just a dictionary from <code class="docutils literal notranslate"><span class="pre">Qubit</span></code> to <code class="docutils literal notranslate"><span class="pre">Bit</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pytket</span> <span class="kn">import</span> <span class="n">Bit</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">tk_to_mymeasures</span><span class="p">(</span><span class="n">tkc</span><span class="p">:</span> <span class="n">Circuit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">MyCircuit</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Qubit</span><span class="p">,</span> <span class="n">Bit</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a pytket Circuit to a MyCircuit object and a measurement map.</span>
<span class="sd">    Supports Rz, Rx, Ry, and ZZMax gates, as well as end-of-circuit measurements.</span>
<span class="sd">    :param tkc: The Circuit to convert</span>
<span class="sd">    :type tkc: Circuit</span>
<span class="sd">    :return: An equivalent MyCircuit object and a map from measured Qubit to the Bit containing the result</span>
<span class="sd">    :rtype: Tuple[MyCircuit, Dict[Qubit, Bit]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">circ</span> <span class="o">=</span> <span class="n">MyCircuit</span><span class="p">(</span><span class="n">tkc</span><span class="o">.</span><span class="n">qubits</span><span class="p">)</span>
    <span class="n">measure_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">measured_units</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">set</span><span class="p">()</span>
    <span class="p">)</span>  <span class="c1"># Track measured Qubits/used Bits to identify mid-circuit measurement</span>
    <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">tkc</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">command</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">measured_units</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Circuit contains a mid-circuit measurement&quot;</span><span class="p">)</span>
        <span class="n">optype</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">type</span>
        <span class="k">if</span> <span class="n">optype</span> <span class="o">==</span> <span class="n">OpType</span><span class="o">.</span><span class="n">Rx</span><span class="p">:</span>
            <span class="n">circ</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span>
                <span class="n">QubitPauliString</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">command</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="n">OpType</span><span class="o">.</span><span class="n">Ry</span><span class="p">:</span>
            <span class="n">circ</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span>
                <span class="n">QubitPauliString</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">Y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">command</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="n">OpType</span><span class="o">.</span><span class="n">Rz</span><span class="p">:</span>
            <span class="n">circ</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span>
                <span class="n">QubitPauliString</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">Z</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">command</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="n">OpType</span><span class="o">.</span><span class="n">ZZMax</span><span class="p">:</span>
            <span class="n">circ</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span>
                <span class="n">QubitPauliString</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="p">[</span><span class="n">Pauli</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">Z</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="n">OpType</span><span class="o">.</span><span class="n">Measure</span><span class="p">:</span>
            <span class="n">measure_map</span><span class="p">[</span><span class="n">command</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">measured_units</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">measured_units</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot convert optype to MyCircuit: &quot;</span><span class="p">,</span> <span class="n">optype</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">circ</span><span class="p">,</span> <span class="n">measure_map</span>
</pre></div>
</div>
</div>
</div>
<p>To build a <code class="docutils literal notranslate"><span class="pre">Backend</span></code> subclass for this sampling simulator, we only need to change how we write <code class="docutils literal notranslate"><span class="pre">required_predicates</span></code> and <code class="docutils literal notranslate"><span class="pre">process_circuits</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pytket.predicates</span> <span class="kn">import</span> <span class="n">NoMidMeasurePredicate</span><span class="p">,</span> <span class="n">NoClassicalControlPredicate</span>
<span class="kn">from</span> <span class="nn">pytket.utils.outcomearray</span> <span class="kn">import</span> <span class="n">OutcomeArray</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MySampler</span><span class="p">(</span><span class="n">Backend</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A pytket Backend wrapping around the MySimulator simulator with readout sampling&quot;&quot;&quot;</span>
    <span class="n">_supports_shots</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_supports_counts</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_persistent_handles</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new instance of the MySampler class&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="n">rebase_pass</span> <span class="o">=</span> <span class="n">rebase</span>
    <span class="n">default_compilation_pass</span> <span class="o">=</span> <span class="n">default_compilation_pass</span>
    <span class="n">_result_id_type</span> <span class="o">=</span> <span class="n">_result_id_type</span>
    <span class="n">circuit_status</span> <span class="o">=</span> <span class="n">circuit_status</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">required_predicates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Predicate</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The minimum set of predicates that a circuit must satisfy before it can</span>
<span class="sd">        be successfully run on this backend.</span>
<span class="sd">        :return: Required predicates.</span>
<span class="sd">        :rtype: List[Predicate]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">NoClassicalControlPredicate</span><span class="p">(),</span>
            <span class="n">NoMidMeasurePredicate</span><span class="p">(),</span>
            <span class="n">GateSetPredicate</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="n">OpType</span><span class="o">.</span><span class="n">Rx</span><span class="p">,</span>
                    <span class="n">OpType</span><span class="o">.</span><span class="n">Ry</span><span class="p">,</span>
                    <span class="n">OpType</span><span class="o">.</span><span class="n">Rz</span><span class="p">,</span>
                    <span class="n">OpType</span><span class="o">.</span><span class="n">ZZMax</span><span class="p">,</span>
                    <span class="n">OpType</span><span class="o">.</span><span class="n">Measure</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">),</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">preds</span>
    <span class="k">def</span> <span class="nf">process_circuits</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">circuits</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Circuit</span><span class="p">],</span>
        <span class="n">n_shots</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">valid_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">KwargTypes</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ResultHandle</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submit circuits to the backend for running. The results will be stored</span>
<span class="sd">        in the backend&#39;s result cache to be retrieved by the corresponding</span>
<span class="sd">        get_&lt;data&gt; method.</span>
<span class="sd">        Use keyword arguments to specify parameters to be used in submitting circuits</span>
<span class="sd">        See specific Backend derived class for available parameters, from the following</span>
<span class="sd">        list:</span>
<span class="sd">        * `seed`: RNG seed for simulators</span>
<span class="sd">        :param circuits: Circuits to process on the backend.</span>
<span class="sd">        :type circuits: Iterable[Circuit]</span>
<span class="sd">        :param n_shots: Number of shots to run per circuit. None is to be used</span>
<span class="sd">            for state/unitary simulators. Defaults to None.</span>
<span class="sd">        :type n_shots: Optional[int], optional</span>
<span class="sd">        :param valid_check: Explicitly check that all circuits satisfy all required</span>
<span class="sd">            predicates to run on the backend. Defaults to True</span>
<span class="sd">        :type valid_check: bool, optional</span>
<span class="sd">        :return: Handles to results for each input circuit, as an interable in</span>
<span class="sd">            the same order as the circuits.</span>
<span class="sd">        :rtype: List[ResultHandle]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">circuit_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">circuits</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">valid_check</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_all_circuits</span><span class="p">(</span><span class="n">circuit_list</span><span class="p">)</span>
        <span class="n">handle_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">circuit</span> <span class="ow">in</span> <span class="n">circuit_list</span><span class="p">:</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="n">ResultHandle</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()))</span>
            <span class="n">mycirc</span><span class="p">,</span> <span class="n">measure_map</span> <span class="o">=</span> <span class="n">tk_to_mymeasures</span><span class="p">(</span><span class="n">circuit</span><span class="p">)</span>
            <span class="n">qubit_list</span><span class="p">,</span> <span class="n">bit_list</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">measure_map</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">qubit_shots</span> <span class="o">=</span> <span class="n">sample_mycircuit</span><span class="p">(</span>
                <span class="n">mycirc</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">qubit_list</span><span class="p">),</span> <span class="n">n_shots</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;seed&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># Pad shot table with 0 columns for unused bits</span>
            <span class="n">all_shots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_shots</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">circuit</span><span class="o">.</span><span class="n">bits</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">all_shots</span><span class="p">[:,</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">qubit_list</span><span class="p">)]</span> <span class="o">=</span> <span class="n">qubit_shots</span>
            <span class="n">res_bits</span> <span class="o">=</span> <span class="p">[</span><span class="n">measure_map</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">qubit_list</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">circuit</span><span class="o">.</span><span class="n">bits</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bit_list</span><span class="p">:</span>
                    <span class="n">res_bits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">BackendResult</span><span class="p">(</span>
                <span class="n">c_bits</span><span class="o">=</span><span class="n">res_bits</span><span class="p">,</span> <span class="n">shots</span><span class="o">=</span><span class="n">OutcomeArray</span><span class="o">.</span><span class="n">from_readouts</span><span class="p">(</span><span class="n">all_shots</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">handle</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">}</span>
            <span class="n">handle_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">handle_list</span>
</pre></div>
</div>
</div>
</div>
<p>Likewise, we run some basic tests to make sure it works.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_sampler_bell</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Circuit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">CX</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">measure_all</span><span class="p">()</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">MySampler</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get_compiled_circuit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">run_circuit</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n_shots</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">res</span><span class="o">.</span><span class="n">get_shots</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">res</span><span class="o">.</span><span class="n">get_counts</span><span class="p">()</span> <span class="o">==</span> <span class="p">{(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">5</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_sampler_basisorder</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Circuit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">measure_all</span><span class="p">()</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">MySampler</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get_compiled_circuit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">run_circuit</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n_shots</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">res</span><span class="o">.</span><span class="n">get_counts</span><span class="p">()</span> <span class="o">==</span> <span class="p">{(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">10</span><span class="p">}</span>
    <span class="k">assert</span> <span class="n">res</span><span class="o">.</span><span class="n">get_counts</span><span class="p">(</span><span class="n">basis</span><span class="o">=</span><span class="n">BasisOrder</span><span class="o">.</span><span class="n">dlo</span><span class="p">)</span> <span class="o">==</span> <span class="p">{(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">10</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_sampler_compilation_pass</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">MySampler</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">opt_level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">Circuit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">CX</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="n">c</span><span class="o">.</span><span class="n">add_unitary1qbox</span><span class="p">(</span><span class="n">Unitary1qBox</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">CX</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="n">OpType</span><span class="o">.</span><span class="n">CRz</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">c</span><span class="o">.</span><span class="n">measure_all</span><span class="p">()</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">valid_circuit</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get_compiled_circuit</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">optimisation_level</span><span class="o">=</span><span class="n">opt_level</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">b</span><span class="o">.</span><span class="n">valid_circuit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_sampler_expectation_value</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Circuit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">CX</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">op</span> <span class="o">=</span> <span class="n">QubitPauliOperator</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="n">QubitPauliString</span><span class="p">({</span><span class="n">Qubit</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="n">Qubit</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">Z</span><span class="p">}):</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="n">QubitPauliString</span><span class="p">({</span><span class="n">Qubit</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">Qubit</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">X</span><span class="p">}):</span> <span class="mf">0.3</span><span class="p">,</span>
            <span class="n">QubitPauliString</span><span class="p">({</span><span class="n">Qubit</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="n">Qubit</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">Y</span><span class="p">}):</span> <span class="mf">0.8</span><span class="n">j</span><span class="p">,</span>
            <span class="n">QubitPauliString</span><span class="p">({</span><span class="n">Qubit</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span> <span class="n">Pauli</span><span class="o">.</span><span class="n">Y</span><span class="p">}):</span> <span class="o">-</span><span class="mf">0.4</span><span class="n">j</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">MySampler</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get_compiled_circuit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">expectation</span> <span class="o">=</span> <span class="n">get_operator_expectation_value</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n_shots</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">expectation</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">expectation</span><span class="p">))</span> <span class="o">==</span> <span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span>
        <span class="p">(</span><span class="mf">1.3</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="nb">abs</span><span class="o">=</span><span class="mf">0.1</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_sampler_bell</span><span class="p">()</span>
<span class="n">test_sampler_basisorder</span><span class="p">()</span>
<span class="n">test_sampler_compilation_pass</span><span class="p">()</span>
<span class="n">test_sampler_expectation_value</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Exercises:<br></p>
<ul class="simple">
<li><p>Add some extra gate definitions to the simulator and expand the accepted gate set of the backends. Start with some that are easily represented as exponentiated Pauli tensors like <code class="docutils literal notranslate"><span class="pre">OpType.YYPhase</span></code>. For a challenge, try adding <code class="docutils literal notranslate"><span class="pre">OpType.CCX</span></code> efficiently (it is possible to encode it using seven Pauli rotations).<br></p></li>
<li><p>Restrict the simulator to a limited qubit connectivity. Express this in the backends by modifying the <code class="docutils literal notranslate"><span class="pre">Architecture</span></code> property of the <code class="docutils literal notranslate"><span class="pre">BackendInfo</span></code> attribute object and adding to the <code class="docutils literal notranslate"><span class="pre">required_predicates</span></code>. Adjust the <code class="docutils literal notranslate"><span class="pre">default_compilation_pass</span></code> to solve for the connectivity.<br></p></li>
<li><p>The file <code class="docutils literal notranslate"><span class="pre">creating_backends_exercise.py</span></code> extends the simulators above to allow for mid-circuit measurement and conditional gates using a binary decision tree. Implement an appropriate converter and <code class="docutils literal notranslate"><span class="pre">Backend</span></code> class for this simulator.</p></li>
</ul>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="contextual_optimization.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Contextual optimisation</p>
      </div>
    </a>
    <a class="right-next"
       href="measurement_reduction_example.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Advanced Expectation Values and Measurement Reduction</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book community
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>